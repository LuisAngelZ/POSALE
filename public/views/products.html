<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Crear Producto - Sistema POS</title>
    <link rel="stylesheet" href="/assets/css/products.css">
</head>
<body>
    <div class="container">
        <!-- Header -->
        <div class="header">
            <h1>üì¶ Crear Nuevo Producto</h1>
            <p>Agrega un nuevo producto al inventario del sistema</p>
        </div>

        <!-- Breadcrumb -->
        <div class="breadcrumb">
            <a href="/dashboard.html">Dashboard</a>
            <span>‚Ä∫</span>
            <a href="#" onclick="showSection('products')">Productos</a>
            <span>‚Ä∫</span>
            <span>Crear Producto</span>
        </div>

        <!-- Formulario -->
        <div class="form-card">
            <form id="productForm">
                <!-- Informaci√≥n B√°sica -->
                <div class="form-section">
                    <h3 class="section-title">
                        <span>üìù</span>
                        Informaci√≥n B√°sica
                    </h3>
                    
                    <div class="form-grid">
                        <div class="form-group">
                            <label for="productName" class="form-label required">Nombre del Producto</label>
                            <input type="text" id="productName" name="name" class="form-input" 
                                   placeholder="Ej: Pizza Margherita" required maxlength="100">
                            <div class="input-helper">M√°ximo 100 caracteres</div>
                        </div>

                        <div class="form-group">
                            <label for="productPrice" class="form-label required">Precio</label>
                            <div class="price-input-wrapper">
                                <span class="price-symbol">$</span>
                                <input type="number" id="productPrice" name="price" class="form-input price-input" 
                                       placeholder="0.00" step="0.01" min="0" required>
                            </div>
                            <div class="input-helper">Precio en bolivianos (Bs.)</div>
                        </div>
                    </div>

                    <div class="form-group full-width">
                        <label for="productDescription" class="form-label">Descripci√≥n</label>
                        <textarea id="productDescription" name="description" class="form-input form-textarea" 
                                  placeholder="Descripci√≥n detallada del producto..." maxlength="500"></textarea>
                        <div class="input-helper">Opcional - M√°ximo 500 caracteres</div>
                    </div>
                </div>

                <!-- Categor√≠a -->
                <div class="form-section">
                    <h3 class="section-title">
                        <span>üè∑Ô∏è</span>
                        Categor√≠a
                    </h3>
                    
                    <input type="hidden" id="selectedCategoryId" name="category_id" required>
                    
                    <div class="category-grid" id="categoryGrid">
                        <!-- Las categor√≠as se cargan din√°micamente -->
                        <div style="grid-column: 1 / -1; text-align: center; padding: 2rem; color: #6b7280;">
                            Cargando categor√≠as...
                        </div>
                    </div>

                    <div class="quick-actions">
                        <div class="quick-actions-title">‚ö° Acciones R√°pidas</div>
                        <button type="button" class="quick-action-btn" onclick="createNewCategory()">
                            ‚ûï Nueva Categor√≠a
                        </button>
                        <button type="button" class="quick-action-btn" onclick="refreshCategories()">
                            üîÑ Actualizar Lista
                        </button>
                    </div>
                </div>

                <!-- Sistema de Imagen Mejorado -->
                <div class="form-section">
                    <h3 class="section-title">
                        <span>üñºÔ∏è</span>
                        Imagen del Producto
                    </h3>
                    
                    <!-- Opciones de imagen -->
                    <div class="image-options">
                        <div class="image-option active" onclick="selectImageMode('upload')">
                            <div class="option-title">üìÅ Subir Archivo</div>
                            <div class="option-desc">Sube una imagen desde tu computadora</div>
                        </div>
                        <div class="image-option" onclick="selectImageMode('url')">
                            <div class="option-title">üåê URL Externa</div>
                            <div class="option-desc">Usar imagen desde internet</div>
                        </div>
                    </div>

                    <!-- Secci√≥n de subida de archivo -->
                    <div id="uploadSection" class="image-upload-section">
                        <input type="file" id="imageFile" class="file-input" accept="image/*" onchange="handleFileSelect(event)">
                        <div class="upload-placeholder" id="uploadPlaceholder">
                            <div class="upload-icon">üì∑</div>
                            <div class="upload-text">Haz clic o arrastra una imagen aqu√≠</div>
                            <div class="upload-hint">JPG, PNG, GIF hasta 5MB</div>
                        </div>
                        <div id="filePreview" class="hidden"></div>
                    </div>

                    <!-- Secci√≥n de URL -->
                    <div id="urlSection" class="url-input-section hidden">
                        <label for="productImageUrl" class="form-label">URL de la Imagen</label>
                        <input type="url" id="productImageUrl" name="image_url" class="form-input" 
                               placeholder="https://ejemplo.com/imagen.jpg" onchange="handleUrlChange()">
                        <div class="input-helper">URL de una imagen del producto</div>
                        <div id="urlPreview" class="hidden" style="margin-top: 1rem;"></div>
                    </div>
                </div>

                <!-- Botones -->
                <div class="button-group">
                    <button type="button" class="btn btn-secondary" onclick="cancelForm()">
                        <span>‚ùå</span>
                        Cancelar
                    </button>
                    <button type="submit" class="btn btn-primary" id="submitBtn">
                        <span>üíæ</span>
                        Crear Producto
                    </button>
                </div>
            </form>
        </div>
    </div>

    <script>
        // Variables globales
        let authToken = localStorage.getItem('pos_token');
        let categories = [];
        let selectedCategoryId = null;
        let currentImageMode = 'upload';
        let selectedImageFile = null;
        let currentImageUrl = null;
        const API_BASE = '/api';

        // Verificar autenticaci√≥n
        if (!authToken) {
            window.location.href = '/login.html';
        }

        // Inicializar p√°gina
        document.addEventListener('DOMContentLoaded', function() {
            setupFormHandlers();
            setupImageHandlers();
            loadCategories();
        });

        // Configurar manejadores del formulario
        function setupFormHandlers() {
            const form = document.getElementById('productForm');
            
            // Manejar env√≠o del formulario
            form.addEventListener('submit', handleSubmit);
            
            // Validaciones en tiempo real
            setupValidation();
        }

        // Configurar manejadores de imagen
        function setupImageHandlers() {
            const uploadSection = document.getElementById('uploadSection');
            
            // Drag and drop
            uploadSection.addEventListener('dragover', function(e) {
                e.preventDefault();
                uploadSection.classList.add('dragover');
            });

            uploadSection.addEventListener('dragleave', function(e) {
                e.preventDefault();
                uploadSection.classList.remove('dragover');
            });

            uploadSection.addEventListener('drop', function(e) {
                e.preventDefault();
                uploadSection.classList.remove('dragover');
                
                const files = e.dataTransfer.files;
                if (files.length > 0) {
                    handleFileSelect({ target: { files: files } });
                }
            });
        }

        // Seleccionar modo de imagen
        function selectImageMode(mode) {
            currentImageMode = mode;
            
            // Actualizar opciones visuales
            document.querySelectorAll('.image-option').forEach(option => {
                option.classList.remove('active');
            });
            event.target.closest('.image-option').classList.add('active');
            
            // Mostrar/ocultar secciones
            const uploadSection = document.getElementById('uploadSection');
            const urlSection = document.getElementById('urlSection');
            
            if (mode === 'upload') {
                uploadSection.classList.remove('hidden');
                urlSection.classList.add('hidden');
                currentImageUrl = null;
            } else {
                uploadSection.classList.add('hidden');
                urlSection.classList.remove('hidden');
                selectedImageFile = null;
            }
        }

        // Manejar selecci√≥n de archivo
        function handleFileSelect(event) {
            const file = event.target.files[0];
            if (!file) return;

            // Validar tipo de archivo
            if (!file.type.startsWith('image/')) {
                showNotification('Por favor selecciona un archivo de imagen v√°lido', 'error');
                return;
            }

            // Validar tama√±o (5MB m√°ximo)
            if (file.size > 5 * 1024 * 1024) {
                showNotification('La imagen debe ser menor a 5MB', 'error');
                return;
            }

            selectedImageFile = file;

            // Crear preview
            const reader = new FileReader();
            reader.onload = function(e) {
                showImagePreview(e.target.result, file.name, file.size);
            };
            reader.readAsDataURL(file);
        }

        // Manejar cambio de URL
        function handleUrlChange() {
            const url = document.getElementById('productImageUrl').value;
            if (url) {
                currentImageUrl = url;
                showUrlPreview(url);
            } else {
                currentImageUrl = null;
                document.getElementById('urlPreview').innerHTML = '';
                document.getElementById('urlPreview').classList.add('hidden');
            }
        }

        // Mostrar preview de imagen subida
        function showImagePreview(src, fileName, fileSize) {
            const uploadPlaceholder = document.getElementById('uploadPlaceholder');
            const filePreview = document.getElementById('filePreview');
            
            uploadPlaceholder.classList.add('hidden');
            filePreview.classList.remove('hidden');
            
            const sizeText = (fileSize / 1024 / 1024).toFixed(2) + ' MB';
            
            filePreview.innerHTML = `
                <div class="image-preview">
                    <img src="${src}" alt="Preview">
                    <div class="image-actions">
                        <button type="button" class="image-action-btn" onclick="removeImage()" title="Eliminar">
                            üóëÔ∏è
                        </button>
                    </div>
                    <div class="image-info">
                        üìÑ ${fileName} ‚Ä¢ ${sizeText}
                    </div>
                </div>
            `;
        }

        // Mostrar preview de URL
        function showUrlPreview(url) {
            const urlPreview = document.getElementById('urlPreview');
            urlPreview.classList.remove('hidden');
            
            urlPreview.innerHTML = `
                <div class="image-preview">
                    <img src="${url}" alt="Preview" onerror="showUrlError()">
                    <div class="image-actions">
                        <button type="button" class="image-action-btn" onclick="removeUrlImage()" title="Eliminar">
                            üóëÔ∏è
                        </button>
                    </div>
                    <div class="image-info">
                        üåê Imagen externa
                    </div>
                </div>
            `;
        }

        // Eliminar imagen subida
        function removeImage() {
            selectedImageFile = null;
            document.getElementById('imageFile').value = '';
            document.getElementById('uploadPlaceholder').classList.remove('hidden');
            document.getElementById('filePreview').classList.add('hidden');
        }

        // Eliminar imagen URL
        function removeUrlImage() {
            currentImageUrl = null;
            document.getElementById('productImageUrl').value = '';
            document.getElementById('urlPreview').classList.add('hidden');
        }

        // Error en imagen URL
        function showUrlError() {
            document.getElementById('urlPreview').innerHTML = `
                <div style="text-align: center; padding: 2rem; color: #ef4444; border: 2px solid #fecaca; border-radius: 8px; background: #fef2f2;">
                    <div style="font-size: 2rem; margin-bottom: 0.5rem;">‚ùå</div>
                    <div>Error cargando la imagen</div>
                    <div style="font-size: 0.8rem; margin-top: 0.5rem;">Verifica que la URL sea correcta</div>
                </div>
            `;
        }

        // Cargar categor√≠as
        async function loadCategories() {
            try {
                const response = await fetch(`${API_BASE}/categories`, {
                    headers: { 'Authorization': `Bearer ${authToken}` }
                });

                if (response.ok) {
                    const data = await response.json();
                    categories = data.categories;
                    renderCategories();
                } else {
                    throw new Error('Error cargando categor√≠as');
                }
            } catch (error) {
                console.error('Error:', error);
                showNotification('Error cargando categor√≠as', 'error');
            }
        }

        // Renderizar categor√≠as
        function renderCategories() {
            const categoryGrid = document.getElementById('categoryGrid');
            
            if (categories.length === 0) {
                categoryGrid.innerHTML = `
                    <div style="grid-column: 1 / -1; text-align: center; padding: 2rem; color: #6b7280;">
                        No hay categor√≠as disponibles. 
                        <button type="button" class="quick-action-btn" onclick="createNewCategory()" style="margin-left: 0.5rem;">
                            Crear Primera Categor√≠a
                        </button>
                    </div>
                `;
                return;
            }

            categoryGrid.innerHTML = categories.map(category => `
                <div class="category-option" onclick="selectCategory(${category.id}, '${category.name}')">
                    <div class="category-name">${category.name}</div>
                    <div class="category-desc">${category.description || 'Sin descripci√≥n'}</div>
                </div>
            `).join('');
        }

        // Seleccionar categor√≠a
        function selectCategory(categoryId, categoryName) {
            // Remover selecci√≥n anterior
            document.querySelectorAll('.category-option').forEach(option => {
                option.classList.remove('selected');
            });
            
            // Seleccionar nueva categor√≠a
            event.target.closest('.category-option').classList.add('selected');
            
            selectedCategoryId = categoryId;
            document.getElementById('selectedCategoryId').value = categoryId;
            
            console.log(`Categor√≠a seleccionada: ${categoryName} (ID: ${categoryId})`);
        }

        // Configurar validaciones
        function setupValidation() {
            const nameInput = document.getElementById('productName');
            const priceInput = document.getElementById('productPrice');
            
            nameInput.addEventListener('input', function() {
                const value = this.value.trim();
                if (value.length > 100) {
                    this.setCustomValidity('El nombre no puede exceder 100 caracteres');
                } else if (value.length === 0) {
                    this.setCustomValidity('El nombre es requerido');
                } else {
                    this.setCustomValidity('');
                }
            });

            priceInput.addEventListener('input', function() {
                const value = parseFloat(this.value);
                if (isNaN(value) || value <= 0) {
                    this.setCustomValidity('El precio debe ser mayor a 0');
                } else {
                    this.setCustomValidity('');
                }
            });
        }

        // Manejar env√≠o del formulario
        async function handleSubmit(e) {
            e.preventDefault();
            
            // Validar categor√≠a seleccionada
            if (!selectedCategoryId) {
                showNotification('Por favor selecciona una categor√≠a', 'error');
                return;
            }
            
            const submitBtn = document.getElementById('submitBtn');
            const formData = new FormData(e.target);
            
            let imageUrl = null;

            // Procesar imagen seg√∫n el modo seleccionado
            if (currentImageMode === 'upload' && selectedImageFile) {
                // Convertir archivo a base64 para almacenar
                imageUrl = await convertFileToBase64(selectedImageFile);
            } else if (currentImageMode === 'url' && currentImageUrl) {
                imageUrl = currentImageUrl;
            }

            const productData = {
                name: formData.get('name').trim(),
                description: formData.get('description')?.trim() || null,
                price: parseFloat(formData.get('price')),
                category_id: parseInt(selectedCategoryId),
                image_url: imageUrl
            };

            try {
                // Mostrar loading
                submitBtn.disabled = true;
                submitBtn.innerHTML = '<span class="loading-spinner"></span> Creando...';
                
                const response = await fetch(`${API_BASE}/products`, {
                    method: 'POST',
                    headers: {
                        'Authorization': `Bearer ${authToken}`,
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify(productData)
                });

                const result = await response.json();

                if (response.ok) {
                    showNotification('¬°Producto creado exitosamente!', 'success');
                    
                    // Limpiar formulario despu√©s de 2 segundos
                    setTimeout(() => {
                        resetForm();
                    }, 2000);
                    
                } else {
                    throw new Error(result.message || 'Error creando producto');
                }

            } catch (error) {
                console.error('Error:', error);
                showNotification(error.message, 'error');
            } finally {
                submitBtn.disabled = false;
                submitBtn.innerHTML = '<span>üíæ</span> Crear Producto';
            }
        }

        // Convertir archivo a base64
        async function convertFileToBase64(file) {
            return new Promise((resolve, reject) => {
                const reader = new FileReader();
                reader.onload = () => resolve(reader.result);
                reader.onerror = reject;
                reader.readAsDataURL(file);
            });
        }

        // Limpiar formulario
        function resetForm() {
            document.getElementById('productForm').reset();
            selectedCategoryId = null;
            selectedImageFile = null;
            currentImageUrl = null;
            document.getElementById('selectedCategoryId').value = '';
            
            // Remover selecciones de categor√≠a
            document.querySelectorAll('.category-option').forEach(option => {
                option.classList.remove('selected');
            });
            
            // Resetear im√°genes
            removeImage();
            removeUrlImage();
            selectImageMode('upload');
        }

        // Cancelar formulario
        function cancelForm() {
            if (confirm('¬øEst√°s seguro? Se perder√°n todos los datos ingresados.')) {
                window.history.back();
            }
        }

        // Crear nueva categor√≠a con formulario mejorado
        function createNewCategory() {
            // Crear modal para nueva categor√≠a
            const modal = document.createElement('div');
            modal.style.cssText = `
                position: fixed;
                top: 0;
                left: 0;
                right: 0;
                bottom: 0;
                background: rgba(0, 0, 0, 0.5);
                display: flex;
                align-items: center;
                justify-content: center;
                z-index: 1000;
            `;

            modal.innerHTML = `
                <div style="
                    background: white;
                    border-radius: 16px;
                    padding: 2rem;
                    max-width: 500px;
                    width: 90%;
                    box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3);
                ">
                    <h3 style="margin-bottom: 1rem; color: #1e293b; font-size: 1.3rem;">
                        üè∑Ô∏è Crear Nueva Categor√≠a
                    </h3>
                    
                    <div style="margin-bottom: 1rem;">
                        <label style="display: block; margin-bottom: 0.5rem; font-weight: 600; color: #374151;">
                            Nombre de la Categor√≠a *
                        </label>
                        <input type="text" id="modalCategoryName" style="
                            width: 100%;
                            padding: 0.75rem;
                            border: 2px solid #e5e7eb;
                            border-radius: 8px;
                            font-size: 1rem;
                        " placeholder="Ej: Bebidas, Comidas, Postres..." maxlength="100" required>
                    </div>
                    
                    <div style="margin-bottom: 2rem;">
                        <label style="display: block; margin-bottom: 0.5rem; font-weight: 600; color: #374151;">
                            Descripci√≥n
                        </label>
                        <textarea id="modalCategoryDesc" style="
                            width: 100%;
                            padding: 0.75rem;
                            border: 2px solid #e5e7eb;
                            border-radius: 8px;
                            font-size: 1rem;
                            min-height: 80px;
                            resize: vertical;
                            font-family: inherit;
                        " placeholder="Describe el tipo de productos..." maxlength="255"></textarea>
                    </div>
                    
                    <div style="display: flex; gap: 1rem; justify-content: flex-end;">
                        <button onclick="closeModal()" style="
                            background: #f1f5f9;
                            color: #475569;
                            border: 1px solid #e2e8f0;
                            padding: 0.75rem 1.5rem;
                            border-radius: 8px;
                            cursor: pointer;
                            font-weight: 600;
                        ">Cancelar</button>
                        
                        <button onclick="submitNewCategory()" id="modalSubmitBtn" style="
                            background: linear-gradient(135deg, #f59e0b, #f97316);
                            color: white;
                            border: none;
                            padding: 0.75rem 1.5rem;
                            border-radius: 8px;
                            cursor: pointer;
                            font-weight: 600;
                        ">Crear Categor√≠a</button>
                    </div>
                </div>
            `;

            document.body.appendChild(modal);
            document.getElementById('modalCategoryName').focus();

            // Cerrar modal al hacer clic fuera
            modal.addEventListener('click', function(e) {
                if (e.target === modal) {
                    closeModal();
                }
            });

            // Funci√≥n para cerrar modal
            window.closeModal = function() {
                document.body.removeChild(modal);
                delete window.closeModal;
                delete window.submitNewCategory;
            };

            // Funci√≥n para enviar nueva categor√≠a
            window.submitNewCategory = async function() {
                const name = document.getElementById('modalCategoryName').value.trim();
                const description = document.getElementById('modalCategoryDesc').value.trim();
                const submitBtn = document.getElementById('modalSubmitBtn');

                if (!name) {
                    showNotification('El nombre de la categor√≠a es requerido', 'error');
                    return;
                }

                try {
                    submitBtn.disabled = true;
                    submitBtn.textContent = 'Creando...';

                    const response = await fetch(`${API_BASE}/categories`, {
                        method: 'POST',
                        headers: {
                            'Authorization': `Bearer ${authToken}`,
                            'Content-Type': 'application/json'
                        },
                        body: JSON.stringify({ name, description: description || null })
                    });

                    const result = await response.json();

                    if (response.ok) {
                        showNotification('Categor√≠a creada exitosamente', 'success');
                        await loadCategories(); // Recargar categor√≠as
                        closeModal();
                    } else {
                        throw new Error(result.message || 'Error creando categor√≠a');
                    }

                } catch (error) {
                    console.error('Error:', error);
                    showNotification(error.message, 'error');
                    submitBtn.disabled = false;
                    submitBtn.textContent = 'Crear Categor√≠a';
                }
            };
        }

        // Actualizar categor√≠as
        function refreshCategories() {
            showNotification('Actualizando categor√≠as...', 'success');
            loadCategories();
        }

        // Mostrar notificaciones
        function showNotification(message, type = 'success') {
            // Remover notificaci√≥n anterior si existe
            const existing = document.querySelector('.notification');
            if (existing) {
                existing.remove();
            }
            
            const notification = document.createElement('div');
            notification.className = `notification ${type}`;
            notification.textContent = message;
            
            document.body.appendChild(notification);
            
            setTimeout(() => notification.classList.add('show'), 100);
            
            setTimeout(() => {
                notification.classList.remove('show');
                setTimeout(() => {
                    if (document.body.contains(notification)) {
                        document.body.removeChild(notification);
                    }
                }, 300);
            }, 3000);
        }

        // Mostrar secci√≥n (para breadcrumb)
        function showSection(section) {
            window.location.href = '/dashboard.html';
        }
    </script>
</body>
</html>